{% extends 'base.html' %}
{% load static %}
{% block content %}
<h3 style="text-align: center;">How Accessible is each station?</h3>
<p>Click on the links below the map to submit feedback about a station </p>

    <!-- Main -->
    <main>
        <div id='map' style='width: 900px; height: 500px;'></div>
    </main>

    <ul>
        {% for object in object_list %}
            <li><a href="{% url 'stationfeedback' object.pk %}">{{object.stop_name}} {{object.line}}</li>
        {% empty %}
            <li>Something went wrong.</li>
        {% endfor %}
    </ul>

    <!-- Scripts -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>

    <script>

        mapboxgl.accessToken = 'pk.eyJ1IjoiaWNkb25pcyIsImEiOiJjbGZlY3RmYTkwMmxvM3Bxbnp2YnU2aWR2In0.OdqH3NLK3-fyd6UDcI5gbQ';
        var map = new mapboxgl.Map({
            container: 'map',
            center: [-73.93006, 40.69218],
            style: 'mapbox://styles/mapbox/streets-v11',
            zoom: 10
        });

        // this counts as loading your data
        const geojson_values = {
          type: 'FeatureCollection',
          features: []

        };

        const lat_values = {{lat}}
        const lon_values = {{lon}}
        const stop_names = {{stop_name | safe}}
        const line_names = {{line_name | safe}}
        const ada_counts = {{adas}}
        
        let i = 0
        while (i < lat_values.length)
        {
            lat = lat_values[i]
            lon = lon_values[i]
            geojson_values.features.push({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [lon, lat]
                },
                properties: {
                    station_name: stop_names[i],
                    line_name: line_names[i],
                    ada: ada_counts[i]
                }
            })

            i++
        }

        // Add markers to the map.
        for (const marker of geojson_values.features) {
            // Create a DOM element for each marker.
            const el = document.createElement('div');
            const width = 5;
            const height = 5;
            el.className = 'marker';

            console.log(marker.properties.ada)

            if (marker.properties.ada > 0) {
                el.style.backgroundImage = "url({% static 'images/accessible_icon.jpg' %})";
            }

            el.style.width = '10px';
            el.style.height = '10px';
            el.style.backgroundSize = '100%';
            
            // Add markers to the map.
            new mapboxgl.Marker(el)
            .setLngLat(marker.geometry.coordinates)
            .addTo(map);
            }


        map.on('load', () => {
            /* Add the data to your map as a layer */
            map.addLayer({
              id: 'locations',
              type: 'circle',
              /* Add a GeoJSON source containing place coordinates and information. */
              source: {
                type: 'geojson',
                data: geojson_values
              }
            });
          });

        var popup = new mapboxgl.Popup({
            closeOnClick: false,
            offset: [0, -15]
          })

        map.on('mousemove', 'locations', (e) => {
            const name = e.features[0].properties.station_name;
            const line = e.features[0].properties.line_name;
            const coordinates = e.features[0].geometry.coordinates.slice();

            popup
                .setLngLat(coordinates)
                .setHTML(name.concat(' - ').concat(line))
                .addTo(map);
        });

        map.on('mouseleave', 'locations', (e) => {
            popup.remove();
        });


    </script>
{% endblock content %}